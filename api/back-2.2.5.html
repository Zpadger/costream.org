

<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <title>Stage Assignment — COStream</title>
    <meta charset="utf-8">
    <meta name="description" content="COStream - The High Performance Dataflow Language and Compiler">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

    <link rel="alternate" hreflang="x-default" href="https://costream.site/api/back-2.2.5.html">
    <link rel="alternate" hreflang="zh" href="https://cn.costream.site/api/back-2.2.5.html">

    <meta property="og:type" content="article">
    <meta property="og:title" content="Stage Assignment — COStream">
    <meta property="og:description" content="COStream - The High Performance Dataflow Language and Compiler">
    <meta property="og:image" content="https://cn.costream.site/images/logo.png">

    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Stage Assignment — COStream">
    <meta name="twitter:description" content="COStream - The High Performance Dataflow Language and Compiler">
    <meta name="twitter:image" content="https://cn.costream.site/images/logo.png">

<!--
    <link rel="apple-touch-icon" sizes="57x57" href="/images/icons/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/images/icons/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/images/icons/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/images/icons/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/images/icons/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/images/icons/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/images/icons/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/images/icons/apple-icon-152x152.png">
-->
    <link rel="apple-touch-icon" sizes="180x180" href="/images/icons/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="/images/icons/android-icon-192x192.png">
<!--
    <link rel="icon" type="image/png" sizes="32x32" href="/images/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/images/icons/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/images/icons/favicon-16x16.png">
-->
    <meta name="msapplication-TileImage" content="/images/icons/favicon.png">
    <link rel="icon" href="/images/icons/favicon.png" type="image/png">

    <meta name="msapplication-TileColor" content="#4fc08d">
    <meta name="theme-color" content="#4fc08d">

    <meta name="msapplication-config" content="browserconfig.xml">
    <link rel="manifest" href="/manifest.json">

    <!-- <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600|Roboto Mono' rel='stylesheet' type='text/css'> -->
    <!-- <link href='//fonts.googleapis.com/css?family=Dosis:500&text=Vue.js' rel='stylesheet' type='text/css'> -->

    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- main page styles -->
    <link rel="stylesheet" href="/css/page.css">

    <!-- this needs to be loaded before guide's inline scripts -->
    <script src="/js/vue.js"></script>
    <script>window.PAGE_TYPE = "api"</script>

    <!-- ga -->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-46852172-3', 'cn.costream.site');
      ga('send', 'pageview');
    </script>
  </head>
  <body class="docs">
    <div id="mobile-bar" >
      <a class="menu-button"></a>
      <a class="logo" href="/"></a>
    </div>
    <div id="header">
  <a id="logo" href="/">
    <img src="/images/CO.svg">
    <span>COStream</span>
  </a>
  <ul id="nav">
    <li>
  <form id="search-form">
    <input type="text" id="search-query-nav" class="search-query st-default-search-input">
  </form>
</li>
<li>
    <a href="/guide/installation.html" class="nav-link team">Install</a>
</li>
<li class="nav-dropdown-container learn">
  <a class="nav-link current">Learn</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li><ul>
        <li><a href="/guide/" class="nav-link">Guide</a></li>
        <li><a href="/guide/grammar-book/grammar.html" class="nav-link">Grammar</a></li>
        <li><a href="/api/" class="nav-link current">Source</a></li>
      <li><a href="/examples/" class="nav-link">Examples</a></li>
    </ul></li>
  </ul>
</li>

<li class="nav-dropdown-container ecosystem">
  <a class="nav-link">Ecosystem</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li><h4>Help</h4></li>
    <li><ul>
        <li><a href="https://github.com/DML308/COStream/issues" class="nav-link" target="_blank">Forum</a></li>
    </ul></li>
    <li><h4>Tool</h4></li>
    <li>
      <ul>
        <li><a href="https://try.costream.site" class="nav-link" target="_blank"> Dev Online</a></li>
        <li><a href="https://costream.site" class="nav-link" target="_blank">Highlight Plugin</a></li>
      </ul>
    </li>
    <li><h4>Core Libraries</h4></li>
    <li><ul>
<!--    via 陈铭涛-->
      <li><a href="#" class="nav-link" target="_blank">GPU Computing</a></li>
<!--    via 李平然-->
      <li><a href="#" class="nav-link" target="_blank">Dynamic Scheduling</a></li>
<!--    via null-->
      <li><a href="#" class="nav-link" target="_blank">Gragh Partition</a></li>
    </ul></li>
    
    <li><h4>Resource Lists</h4></li>
    <li><ul>
      <li><a href="https://github.com/DML308/COStream" class="nav-link" target="_blank">Official Repos</a></li>
    <li><h4>Associated Links</h4></li>
    <li><ul>
        <li><a href="http://www.hust.edu.cn" class="nav-link" target="_blank">HUST</a></li>
        <li><a href="http://media.hust.edu.cn" class="nav-link" target="_blank">DML</a></li>
        <li><a href="http://faculty.hust.edu.cn/yujunqing/zh_CN/index.htm" class="nav-link" target="_blank">Mater Enrollment</a></li>
        </ul></li> 
    </ul></li>
  </ul>
</li>

<li>
  <a href="/guide/team.html" class="nav-link team">Team</a>
</li>
<!--
<li>
    <a href="#" class="nav-link team">团队</a>
</li>
-->
<li class="nav-dropdown-container language">
  <a class="nav-link">Language</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li><a href="https://costream.site/api/back-2.2.5.html" class="nav-link" target="_blank">English</a></li>
    <li><a href="https://cn.costream.site/api/back-2.2.5.html" class="nav-link" target="_blank">简体中文</a></li>
  </ul>
</li>

<!--<li><a href="https://github.com/vuejs/cn.vuejs.org/" target="_blank" class="nav-link contribute">参与翻译</a></li>-->

  </ul>
</div>

    
      <div id="main" class="fix-sidebar">
        
          
  <div class="sidebar">
  <div class="sidebar-inner">
    <ul class="main-menu">
      <li>
  <form id="search-form">
    <input type="text" id="search-query-sidebar" class="search-query st-default-search-input">
  </form>
</li>
<li>
    <a href="/guide/installation.html" class="nav-link team">Install</a>
</li>
<li class="nav-dropdown-container learn">
  <a class="nav-link current">Learn</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li><ul>
        <li><a href="/guide/" class="nav-link">Guide</a></li>
        <li><a href="/guide/grammar-book/grammar.html" class="nav-link">Grammar</a></li>
        <li><a href="/api/" class="nav-link current">Source</a></li>
      <li><a href="/examples/" class="nav-link">Examples</a></li>
    </ul></li>
  </ul>
</li>

<li class="nav-dropdown-container ecosystem">
  <a class="nav-link">Ecosystem</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li><h4>Help</h4></li>
    <li><ul>
        <li><a href="https://github.com/DML308/COStream/issues" class="nav-link" target="_blank">Forum</a></li>
    </ul></li>
    <li><h4>Tool</h4></li>
    <li>
      <ul>
        <li><a href="https://try.costream.site" class="nav-link" target="_blank"> Dev Online</a></li>
        <li><a href="https://costream.site" class="nav-link" target="_blank">Highlight Plugin</a></li>
      </ul>
    </li>
    <li><h4>Core Libraries</h4></li>
    <li><ul>
<!--    via 陈铭涛-->
      <li><a href="#" class="nav-link" target="_blank">GPU Computing</a></li>
<!--    via 李平然-->
      <li><a href="#" class="nav-link" target="_blank">Dynamic Scheduling</a></li>
<!--    via null-->
      <li><a href="#" class="nav-link" target="_blank">Gragh Partition</a></li>
    </ul></li>
    
    <li><h4>Resource Lists</h4></li>
    <li><ul>
      <li><a href="https://github.com/DML308/COStream" class="nav-link" target="_blank">Official Repos</a></li>
    <li><h4>Associated Links</h4></li>
    <li><ul>
        <li><a href="http://www.hust.edu.cn" class="nav-link" target="_blank">HUST</a></li>
        <li><a href="http://media.hust.edu.cn" class="nav-link" target="_blank">DML</a></li>
        <li><a href="http://faculty.hust.edu.cn/yujunqing/zh_CN/index.htm" class="nav-link" target="_blank">Mater Enrollment</a></li>
        </ul></li> 
    </ul></li>
  </ul>
</li>

<li>
  <a href="/guide/team.html" class="nav-link team">Team</a>
</li>
<!--
<li>
    <a href="#" class="nav-link team">团队</a>
</li>
-->
<li class="nav-dropdown-container language">
  <a class="nav-link">Language</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li><a href="https://costream.site/api/back-2.2.5.html" class="nav-link" target="_blank">English</a></li>
    <li><a href="https://cn.costream.site/api/back-2.2.5.html" class="nav-link" target="_blank">简体中文</a></li>
  </ul>
</li>

<!--<li><a href="https://github.com/vuejs/cn.vuejs.org/" target="_blank" class="nav-link contribute">参与翻译</a></li>-->

    </ul>
    <div class="list">
      
      
        <h2>
          
          Source Explain
<!--
          
            <select class="version-select">
              <option value="SELF" selected>2.x</option>
              <option value="v1">1.0</option>
              <option value="012">0.12</option>
              <option value="011">0.11</option>
            </select>
          
-->
        </h2>
        <ul class="menu-root">
  
    
    
    
	
	
    
    <li>
      <a href="/api/index.html" class="sidebar-link">Overview</a>
    </li>
  
    
    
    
	
      <li><h3>Front end - Parser </h3></li>
      
	
    
    <li>
      <a href="/api/front-2.1.0.html" class="sidebar-link">Get & preprocess Input file</a>
    </li>
  
    
    
    
	
	
    
    <li>
      <a href="/api/front-2.1.1.html" class="sidebar-link">Preprocessing & Environment initialization</a>
    </li>
  
    
    
    
	
	
    
    <li>
      <a href="/api/front-2.1.2.html" class="sidebar-link">Grammar creation and grammar tree generation</a>
    </li>
  
    
    
    
	
	
    
    <li>
      <a href="/api/front-2.1.3.html" class="sidebar-link">Print symbol table</a>
    </li>
  
    
    
    
	
	
    
    <li>
      <a href="/api/front-2.1.4.html" class="sidebar-link">Delete file & verifies the Lexical and grammatical analysis results</a>
    </li>
  
    
    
    
	
	
    
    <li>
      <a href="/api/front-2.1.5.html" class="sidebar-link">Semantic check</a>
    </li>
  
    
    
    
	
	
    
    <li>
      <a href="/api/front-2.1.7.html" class="sidebar-link">Variable rename</a>
    </li>
  
    
    
    
	
	
    
    <li>
      <a href="/api/front-2.1.8.html" class="sidebar-link">Constant propagation</a>
    </li>
  
    
    
    
	
	
    
    <li>
      <a href="/api/front-2.1.9.html" class="sidebar-link">Print AST</a>
    </li>
  
    
    
    
	
	
    
    <li>
      <a href="/api/front-2.1.11.html" class="sidebar-link">Estimate workload of  nodes in flatgraph</a>
    </li>
  
    
    
    
	
	
    
    <li>
      <a href="/api/front-2.1.10.html" class="sidebar-link">AST to Flatgraph</a>
    </li>
  
    
    
    
	
	
      <li><h3>Back end - CodeGenerator</h3></li>
      
    
    <li>
      <a href="/api/back-2.2.1.html" class="sidebar-link">Initial scheduling and steady-state scheduling</a>
    </li>
  
    
    
    
	
	
    
    <li>
      <a href="/api/back-2.2.2.html" class="sidebar-link">Describe the SDF diagram in the form of XML</a>
    </li>
  
    
    
    
	
	
    
    <li>
      <a href="/api/back-2.2.3.html" class="sidebar-link">Parition graph</a>
    </li>
  
    
    
    
	
	
    
    <li>
      <a href="/api/back-2.2.4.html" class="sidebar-link">Print theoretical speedup ratio</a>
    </li>
  
    
    
    
	
	
    
    <li>
      <a href="/api/back-2.2.5.html" class="sidebar-link current">Stage Assignment</a>
    </li>
  
    
    
    
	
	
    
    <li>
      <a href="/api/back-2.2.6.html" class="sidebar-link">Code Generation</a>
    </li>
  
</ul>

      
    </div>
  </div>
</div>


<div class="content api with-sidebar ">
  
    
  
  
    <h1>Stage Assignment</h1>
  
  
    <p>When the compiler proceeds to the stage assignment phase,it means we are close to the code generation module.<br>After partition the flatgraph, each part of the flatgraph has been assigned to the different processor core for execution, the program specifies the assignment of computing tasks on the spatial dimension.And determining the phase number of each computing unit being scheduled by the pipeline is specifying the scheduling of the computing unit in the time dimension。That is what stage assignment algorithm do.<br>Using stage assignment algorithm to construct software pipeline scheduling for task partitioning results is a prelude to the hierarchical pipeline code generation step.</p>
<h2 id="Program-Entrance"><a href="#Program-Entrance" class="headerlink" title="Program Entrance"></a>Program Entrance</h2><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*（6）Stage Assignment */</span></span><br><span class="line"><span class="keyword">if</span> (Errors == <span class="number">0</span> &amp;&amp; X86Backend)  </span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//Step1: construction stage assignment object PAS</span></span><br><span class="line">    pSA = <span class="keyword">new</span> StageAssignment();</span><br><span class="line">    <span class="comment">// Step2:get the topological sequence of flatgraph</span></span><br><span class="line">    pSA-&gt;actorTopologicalorder(SSSG-&gt;GetFlatNodes());</span><br><span class="line">    <span class="comment">// Step3:do stage assignment on flatgraph</span></span><br><span class="line">    pSA-&gt;actorStageMap(mp-&gt;GetFlatNode2PartitionNum());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (Errors == <span class="number">0</span> &amp;&amp; GPUBackend &amp;&amp; MAFLPFlag)</span><br><span class="line">&#123;</span><br><span class="line">    pSA = <span class="keyword">new</span> StageAssignment();</span><br><span class="line">    pSA-&gt;actorTopologicalorder(SSSG-&gt;GetFlatNodes());</span><br><span class="line">    pSA-&gt;actorStageMapForGPU(maflp-&gt;GetFlatNode2PartitionNum());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Construction stage assignment object PAS</li>
<li>Get the topological sequence of flatgraph</li>
<li>Do stage assignment on flatgraph</li>
</ul>
<h2 id="Associated-file"><a href="#Associated-file" class="headerlink" title="Associated file"></a>Associated file</h2><p>(1)    ActorEdgeAssignment.h<br>This file is the declaration header file of the stage assignment module, defining the stage assignment class StageAssignment, which contains the attributes and functions required for stage assignment.</p>
<p><em>protected attributes：</em></p>
<table>
<thead>
<tr>
<th style="text-align:left">Name</th>
<th style="text-align:left">Descritpion</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>vector&lt;FlatNode *&gt;antortopo</code></td>
<td style="text-align:left">The topological sequence of flatgraph</td>
</tr>
<tr>
<td style="text-align:left"><code>map&lt;FlatNode* node,int stagenum&gt;Actor2Stage</code></td>
<td style="text-align:left">The result of stage assignment of each node</td>
</tr>
<tr>
<td style="text-align:left"><code>multimap&lt; int stagenum,FlatNode* node &gt; Stage2Actor</code></td>
<td style="text-align:left">The result of stage assignment of each node</td>
</tr>
<tr>
<td style="text-align:left"><code>vector&lt;FlatNode * node &gt; ActorSet</code></td>
<td style="text-align:left">store actors</td>
</tr>
<tr>
<td style="text-align:left"><code>map&lt;FlatNode* node ,int stagenum &gt; DataOfActor2Stage</code></td>
<td style="text-align:left">The result of stage assignment of each node for GPU</td>
</tr>
<tr>
<td style="text-align:left"><code>multimap&lt; int stagenum,FlatNode* node &gt; Stage2DataOfActor</code></td>
<td style="text-align:left">The result of stage assignment of each node for GPU</td>
</tr>
</tbody>
</table>
<p><em>public functions：</em></p>
<table>
<thead>
<tr>
<th style="text-align:left">Name</th>
<th style="text-align:left">Descritpion</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>void actorStageMap(map&lt;FlatNode*,int&gt; processor2actor)</code></td>
<td style="text-align:left">stage assignment algorithm function</td>
</tr>
<tr>
<td style="text-align:left"><code>void ActorEdgeAssignment ()</code></td>
<td style="text-align:left">topological sorting function</td>
</tr>
<tr>
<td style="text-align:left"><code>int FindStage(FlatNode*)</code></td>
<td style="text-align:left">find stage number of one node</td>
</tr>
<tr>
<td style="text-align:left"><code>vector&lt;FlatNode *&gt; FindActor(int i)</code></td>
<td style="text-align:left">Find nodes with stage number</td>
</tr>
</tbody>
</table>
<p>See sourece file  ActorEdgeAssignment.cpp for detials</p>
<h2 id="Program-process"><a href="#Program-process" class="headerlink" title="Program process"></a>Program process</h2><p>1)    Topological sorting of SDF graph nodes—<code>ActorEdgeAssignment()</code><br>The SDF graph is a directed acyclic graph. The topological sorting idea is used to arrange all the nodes in the graph into a linear sequence as the execution order of all nodes.<br>Topological sorting algorithm：<br>The topological sorting algorithm for constructing topological sequences from AOV network is as follows:<br>① Select a vertex with a degree of 0 and output it;<br>② Remove this vertex and all outgoing edges from the net.<br>③ Repeat ① ② until all points are deleted</p>
<p>2)    Next  program perform an set pipeline stage number for the topologically sorted SDF graph<br>Stage assignment belongs to the data-driven hierarchical pipeline scheduling domain.<br>The implementation ideas are as follows:</p>
<ol>
<li>Inter-cluster node asynchronous pipeline scheduling (data driven, block communication )</li>
<li>Synchronization pipeline scheduling for nodes on multi-cores<br>2.1 different machines: parent node execution does not affect the execution of child nodes<br>2.2 same machine using stage assignment algorithm<br>2.2.1 with the same core: the parent node and the child node are assigned to the same stage to execute<br>2.2.2different cores: the sub-phase number is 1 larger than the parent stage number</li>
</ol>

  
  
  <div class="footer">
	Caught a mistake or want to contribute to the documentation? 
    	
	  <a href="https://github.com/DML308/costream.org/tree/master/src/api/back-2.2.5.md" target="_blank">
		  Edit this page on GitHub!
	  </a>
  	
  </div>
</div>

        
      </div>
      <script src="/js/smooth-scroll.min.js"></script>
    

    <!-- main custom script for sidebars, version selects etc. -->
    <script src="/js/css.escape.js"></script>
    <script src="/js/common.js"></script>

    <!-- search -->
    <link href="//cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css" rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="/css/search.css">
    <script src="//cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script>
    <script>
    [
      '#search-query-nav',
      '#search-query-sidebar',
      '#search-query-menu'
    ].forEach(function (selector) {
      if (!document.querySelector(selector)) return
      // search index defaults to v2
      var match = window.location.pathname.match(/^\/(v\d+)/)
      var version = match ? match[1] : 'v2'
      docsearch({
      appId: 'BH4D9OD16A',
      apiKey: '5638280abff9d207417bb03be05f0b25',
      indexName: 'vuejs_cn2',
      inputSelector: selector,
      algoliaOptions: { facetFilters: ["version:" + version] }
      })
    })
    </script>

    <!-- fastclick -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
      FastClick.attach(document.body)
    }, false)
    </script>
  </body>
</html>
